#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var util = require('util');
var existsSync = fs.existsSync || path.existsSync;
var commands = require('commander');

var packageConfig = fs.readFileSync(path.join(path.dirname(fs.realpathSync(process.argv[1])), '../package.json'));
var buildVersion = JSON.parse(packageConfig).version;

// Taken from MooTools 1.3
var escapeRegExp = function(s) {
  return s.replace(/([-.*+?^${}()|[\]\/\\])/g, '\\$1');
};

commands
  .version(buildVersion, '-v, --version')
  .usage('[options]')
  .option('-a, --assethosts [list]', 'assets host to use in CSS bundles (defaults to none)')
  .option('-b, --cacheboosters', 'add MD5 hash to file names aka hard cache boosters (defaults to false)')
  .option('--bj, --js-bundled [path]', 'path to JavaScript root directory (relative to --root option)')
  .option('--bs, --styles-bundled [path]', 'path to stylesheets root directory (relative to --root option)')
  .option('-c, --config [path]', 'path to file with bundles definition (defaults to ./config/assets.yml)')
  .option('-g, --gzip', 'gzip packaged files (defaults to false)')
  .option('-i, --indent [value]', 'indentation level in spaces when used with --nm switch', parseInt)
  .option('-j, --concurrent [value]', 'number of concurrent tasks executed at once (defaults to number of logical CPUs)', parseInt)
  .option('-l, --line-break-at [value]', 'number of characters per line in optimized JavaScript (defaults to off which means no line splitting)', parseInt)
  .option('-n, --noembedversion', 'create a version of packaged CSS without embedded images (defaults to false)')
  .option('--nm, --nominifyjs', 'combine JS files without minification (defaults to false)')
  .option('-o, --only [list]', 'package only given assets group (or groups if separated by comma)')
  .option('--pj, --js-path [path]', 'path to JavaScript root directory (relative to --root option)')
  .option('--ps, --styles-path [path]', 'path to stylesheets root directory (relative to --root option)')
  .option('-r, --root [path]', 'root directory with assets directories (defaults to ./public)')
  .parse(process.argv);

var options = {
  assetHosts: commands.assethosts,
  cacheBoosters: commands.cacheboosters,
  concurrent: commands.concurrent || require('os').cpus().length,
  config: path.join(process.cwd(), commands.config || 'config/assets.yml'),
  gzip: commands.gzip,
  indentLevel: commands.indent,
  lineBreakAt: commands.lineBreakAt,
  noEmbedVersion: commands.noembedversion,
  noMinifyJS: commands.nominifyjs,
  only: commands.only,
  path: {
    javascripts: commands.jsPath || './javascripts',
    stylesheets: commands.stylesPath || './stylesheets'
  },
  root: path.join(process.cwd(), commands.root || 'public')
};

options.bundledPath = {
  javascripts: commands.jsBundled || path.join(options.path.javascripts, '/bundled'),
  stylesheets: commands.stylesBundled || path.join(options.path.stylesheets, '/bundled')
};

if (options.only) {
  options.only = {
    list: options.only.split(',').map(function(template) {
      return new RegExp(escapeRegExp(template).replace('\\*', '.*'));
    }),
    has: function(name) {
      for (var i = 0, c = this.list.length; i < c; i++) {
        if (this.list[i].test(name))
          return true;
      }
      return false;
    },
    hasCSS: /\.css[,]?/.test(options.only),
    hasJS: /\.js[,]?/.test(options.only)
  };
}

if (!existsSync(options.config)) {
  process.stderr.write('Configuration file "' + options.config + '" is missing!\n');
  return 0;
}

if (!existsSync(options.root)) {
  process.stderr.write('Root path "' + options.root + '" could not be found!\n');
  return 0;
}

var Packager = require('../index');
new Packager(options).process();
